<% content_for :title, "H." %>

<div class="max-w-6xl mx-auto">

  <%# Search — outside the turbo-frame so it never re-renders %>
  <div class="flex items-center gap-4 mb-6">
    <%= form_with url: notes_path, method: :get, local: true,
        data: { controller: "search", action: "input->search#search", turbo_frame: "notes_results" } do |f| %>
      <%= f.hidden_field :sort, value: @sort_col %>
      <%= f.hidden_field :dir, value: @sort_dir %>
      <%= f.text_field :q, value: params[:q],
          placeholder: "Search...",
          class: "border border-black px-3 py-2 text-sm focus:outline-none w-64",
          autocomplete: "off",
          autocorrect: "off",
          autocapitalize: "off",
          spellcheck: "false" %>
    <% end %>
    <% if params[:q].present? %>
      <%= link_to notes_path(sort: @sort_col, dir: @sort_dir),
          class: "text-sm hover:underline",
          data: { turbo_frame: "notes_results" } do %>
        &times; clear
      <% end %>
    <% end %>
  </div>

  <%# Only this frame re-renders on search %>
  <turbo-frame id="notes_results">
    <% if @notes.empty? %>
      <p class="text-sm border border-black p-8 text-center">
        <% if params[:q].present? %>
          No notes matching "<%= params[:q] %>".
        <% else %>
          No notes yet. <%= link_to "Create one", new_note_path, class: "underline" %>.
        <% end %>
      </p>
    <% else %>
      <table class="w-full border border-black text-sm">
        <thead>
          <tr class="border-b border-black">
            <th class="text-left px-4 py-3 font-bold tracking-tighter w-full">Title</th>
            <th class="text-left px-4 py-3 font-bold tracking-tighter whitespace-nowrap">
              <%= sort_link "Updated", "updated_at", @sort_col, @sort_dir, params[:q] %>
            </th>
            <th class="text-left px-4 py-3 font-bold tracking-tighter whitespace-nowrap">
              <%= sort_link "Created", "created_at", @sort_col, @sort_dir, params[:q] %>
            </th>
            <th class="px-4 py-3"></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-black">
          <% @notes.each do |note| %>
            <tr>
              <td class="px-4 py-3">
                <%= link_to note.content.lines.first&.strip&.truncate(80) || "(empty)",
                    note_path(note), class: "hover:underline" %>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-gray-500" title="<%= note.updated_at.strftime('%b %d, %Y %H:%M') %>">
                <%= time_ago_in_words(note.updated_at) %> ago
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-gray-500" title="<%= note.created_at.strftime('%b %d, %Y %H:%M') %>">
                <%= time_ago_in_words(note.created_at) %> ago
              </td>
              <td class="px-4 py-3 whitespace-nowrap">
                <div class="flex items-center gap-3">
                  <%= link_to edit_note_path(note), class: "hover:opacity-50 transition-opacity", title: "Edit" do %>
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                  <% end %>
                  <%= button_to note_path(note), method: :delete,
                      class: "hover:opacity-50 transition-opacity bg-transparent border-0 cursor-pointer p-0",
                      title: "Delete",
                      data: { turbo_method: :delete, turbo_confirm: "Delete?" } do %>
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
                    </svg>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
      <div class="flex items-center justify-between mt-3">
        <p class="text-xs text-gray-500"><%= @pagy.count %> note<%= @pagy.count == 1 ? "" : "s" %></p>
        <% if @pagy.pages > 1 %>
          <nav class="flex items-center gap-1 text-sm">
            <% if @pagy.prev %>
              <%= link_to "←", notes_path(page: @pagy.prev, sort: @sort_col, dir: @sort_dir, q: params[:q]),
                  class: "border border-black px-2 py-1 hover:bg-black hover:text-white transition-colors" %>
            <% end %>
            <% @pagy.series.each do |item| %>
              <% if item == :gap %>
                <span class="px-2 py-1">…</span>
              <% elsif item == @pagy.page %>
                <span class="border border-black px-2 py-1 bg-black text-white"><%= item %></span>
              <% else %>
                <%= link_to item, notes_path(page: item, sort: @sort_col, dir: @sort_dir, q: params[:q]),
                    class: "border border-black px-2 py-1 hover:bg-black hover:text-white transition-colors" %>
              <% end %>
            <% end %>
            <% if @pagy.next %>
              <%= link_to "→", notes_path(page: @pagy.next, sort: @sort_col, dir: @sort_dir, q: params[:q]),
                  class: "border border-black px-2 py-1 hover:bg-black hover:text-white transition-colors" %>
            <% end %>
          </nav>
        <% end %>
      </div>
    <% end %>
  </turbo-frame>

</div>
